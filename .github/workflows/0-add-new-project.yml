# .github/workflows/0-add-new-project.yml
name: 0. Add New Kernel Project
on:
  workflow_dispatch:
    inputs:
      project_key:
        description: 'é¡¹ç›®å”¯ä¸€æ ‡è¯† (ä¾‹å¦‚ s26_sm8850)'
        required: true
      core_config:
        description: |-
          æ ¸å¿ƒé…ç½® (4è¡Œ, ä¸¥æ ¼æŒ‰é¡ºåº):
          1. ä»“åº“è·¯å¾„ (ä¾‹: YuzakiKokuban/android_kernel_samsung_sm8850)
          2. Defconfig æ–‡ä»¶å
          3. å†…æ ¸ç‰ˆæœ¬åŸºç¡€å­—ç¬¦ä¸²
          4. åˆ·æœºåŒ…æ–‡ä»¶åå‰ç¼€
        type: string
        required: true
      build_config:
        description: |-
          ç¼–è¯‘é€‰é¡¹ (3è¡Œ, ä¸¥æ ¼æŒ‰é¡ºåº):
          1. LTO (thin, full æˆ–ç•™ç©º)
          2. ç‰ˆæœ¬å·æ–¹æ³• (param æˆ– file)
          3. æ˜¯å¦éœ€è¦é¢å¤–HOSTç¯å¢ƒ (true æˆ– false)
        type: string
        required: true
      anykernel_config:
        description: |-
          AnyKernel3 é…ç½® (2è¡Œ, ä¸¥æ ¼æŒ‰é¡ºåº):
          1. AnyKernel3 ä»“åº“ URL
          2. AnyKernel3 åˆ†æ”¯å
        type: string
        required: true
      toolchain_urls:
        description: 'å·¥å…·é“¾ä¸‹è½½åœ°å€ (æ¯ä¸ª URL å ä¸€è¡Œ)'
        type: string
        required: true
      toolchain_path_prefix:
        description: 'å·¥å…·é“¾è§£å‹åçš„ prebuilts ç›¸å¯¹è·¯å¾„ (ä¾‹å¦‚ prebuilts)'
        type: string
        required: true
      toolchain_path_exports:
        description: 'éœ€è¦æ·»åŠ åˆ° PATH çš„å·¥å…·é“¾å­ç›®å½• (æ¯ä¸ªè·¯å¾„å ä¸€è¡Œ)'
        type: string
        required: true
      disable_security:
        description: '(å¯é€‰) éœ€è¦ç¦ç”¨çš„ä¸‰æ˜Ÿå®‰å…¨ç‰¹æ€§ (æ¯ä¸ªç‰¹æ€§å ä¸€è¡Œ)'
        type: string
        required: false

jobs:
  add-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ADMIN_TOKEN }}

      - name: Install yq and jq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
          sudo apt-get install -y jq

      - name: Update Project Files
        env:
          INPUT_PROJECT_KEY: ${{ github.event.inputs.project_key }}
          INPUT_CORE_CONFIG: ${{ github.event.inputs.core_config }}
          INPUT_BUILD_CONFIG: ${{ github.event.inputs.build_config }}
          INPUT_AK3_CONFIG: ${{ github.event.inputs.anykernel_config }}
          INPUT_TOOLCHAIN_URLS: ${{ github.event.inputs.toolchain_urls }}
          INPUT_TOOLCHAIN_PATH_PREFIX: ${{ github.event.inputs.toolchain_path_prefix }}
          INPUT_TOOLCHAIN_PATH_EXPORTS: ${{ github.event.inputs.toolchain_path_exports }}
          INPUT_DISABLE_SECURITY: ${{ github.event.inputs.disable_security }}
        run: |
          # --- Parse Inputs ---
          # Core Config
          REPO=$(echo "$INPUT_CORE_CONFIG" | sed -n '1p' | xargs)
          DEFCONFIG=$(echo "$INPUT_CORE_CONFIG" | sed -n '2p' | xargs)
          LOCALVERSION_BASE=$(echo "$INPUT_CORE_CONFIG" | sed -n '3p' | xargs)
          ZIP_NAME_PREFIX=$(echo "$INPUT_CORE_CONFIG" | sed -n '4p' | xargs)
          
          # Build Config
          LTO=$(echo "$INPUT_BUILD_CONFIG" | sed -n '1p' | xargs)
          VERSION_METHOD=$(echo "$INPUT_BUILD_CONFIG" | sed -n '2p' | xargs)
          EXTRA_HOST_ENV=$(echo "$INPUT_BUILD_CONFIG" | sed -n '3p' | xargs)

          # AnyKernel Config
          ANYKERNEL_REPO=$(echo "$INPUT_AK3_CONFIG" | sed -n '1p' | xargs)
          ANYKERNEL_BRANCH=$(echo "$INPUT_AK3_CONFIG" | sed -n '2p' | xargs)

          # Multiline to JSON arrays
          TOOLCHAIN_URLS_JSON=$(echo "$INPUT_TOOLCHAIN_URLS" | jq -R . | jq -s .)
          TOOLCHAIN_PATH_EXPORTS_JSON=$(echo "$INPUT_TOOLCHAIN_PATH_EXPORTS" | jq -R . | jq -s .)
          
          if [ -n "$INPUT_DISABLE_SECURITY" ]; then
            DISABLE_SECURITY_JSON=$(echo "$INPUT_DISABLE_SECURITY" | jq -R . | jq -s .)
          else
            DISABLE_SECURITY_JSON="[]"
          fi

          # --- Update Files ---
          # Build the new project JSON object
          NEW_PROJECT_JSON=$(jq -n \
            --arg repo "$REPO" \
            --arg defconfig "$DEFCONFIG" \
            --arg localversion_base "$LOCALVERSION_BASE" \
            --arg lto "$LTO" \
            --argjson supported_ksu '["sukisuultra", "mksu", "ksu"]' \
            --argjson toolchain_urls "$TOOLCHAIN_URLS_JSON" \
            --arg toolchain_path_prefix "$INPUT_TOOLCHAIN_PATH_PREFIX" \
            --argjson toolchain_path_exports "$TOOLCHAIN_PATH_EXPORTS_JSON" \
            --arg anykernel_repo "$ANYKERNEL_REPO" \
            --arg anykernel_branch "$ANYKERNEL_BRANCH" \
            --arg zip_name_prefix "$ZIP_NAME_PREFIX" \
            --arg version_method "$VERSION_METHOD" \
            --argjson extra_host_env $EXTRA_HOST_ENV \
            --argjson disable_security "$DISABLE_SECURITY_JSON" \
            '{
              repo: $repo,
              defconfig: $defconfig,
              localversion_base: $localversion_base,
              lto: $lto,
              supported_ksu: $supported_ksu,
              toolchain_urls: $toolchain_urls,
              toolchain_path_prefix: $toolchain_path_prefix,
              toolchain_path_exports: $toolchain_path_exports,
              anykernel_repo: $anykernel_repo,
              anykernel_branch: $anykernel_branch,
              zip_name_prefix: $zip_name_prefix,
              version_method: $version_method,
              extra_host_env: $extra_host_env,
              disable_security: $disable_security
            }')

          # Update projects.json
          jq --arg key "$INPUT_PROJECT_KEY" \
             --argjson value "$NEW_PROJECT_JSON" \
             '. + {($key): $value}' \
             configs/projects.json > tmp.json && mv tmp.json configs/projects.json
          echo "âœ… Updated configs/projects.json"

          # Update 2-update-kernelsu.yml
          yq e '.on.workflow_dispatch.inputs.project.options += ["'"$INPUT_PROJECT_KEY"'"]' -i .github/workflows/2-update-kernelsu.yml
          echo "âœ… Updated .github/workflows/2-update-kernelsu.yml"

          # Update 4-universal-build.yml
          yq e '.on.workflow_dispatch.inputs.project.options += ["'"$INPUT_PROJECT_KEY"'"]' -i .github/workflows/4-universal-build.yml
          echo "âœ… Updated .github/workflows/4-universal-build.yml"

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add configs/projects.json .github/workflows/2-update-kernelsu.yml .github/workflows/4-universal-build.yml
          if [[ -n $(git status --porcelain) ]]; then
            git commit -m "feat: Add new project '${{ github.event.inputs.project_key }}' via automated workflow"
            git push
            echo "ğŸš€ Changes have been committed and pushed."
          else
            echo "No changes to commit."
          fi
          
      - name: Display Next Steps
        run: |
          REPO_URL=$(echo "${{ github.event.inputs.core_config }}" | sed -n '1p' | xargs)
          echo "========================================================================"
          echo "ğŸ‰ æ–°é¡¹ç›® '${{ github.event.inputs.project_key }}' å·²æˆåŠŸæ·»åŠ åˆ° CI ä¸­å¿ƒï¼"
          echo ""
          echo "ä¸‹ä¸€æ­¥æ“ä½œ:"
          echo "1. è®¿é—®æ–°çš„å†…æ ¸ä»“åº“: https://github.com/$REPO_URL"
          echo "   åœ¨ Settings -> Secrets and variables -> Actions ä¸­æ·»åŠ åä¸º 'CI_TOKEN' çš„ Secretï¼Œ"
          echo "   å…¶å€¼ä¸ºä½ çš„ Personal Access Tokenã€‚"
          echo ""
          echo "2. è¿”å›æœ¬ä»“åº“ (Kokuban_Kernel_CI_Center) çš„ Actions é¡µé¢ï¼Œ"
          echo "   è¿è¡Œ '1. Setup Kernel Repositories' å·¥ä½œæµï¼Œä¸ºæ–°ä»“åº“ä¸€é”®é…ç½®å¥½è§¦å‘å™¨ã€‚"
          echo "========================================================================"

