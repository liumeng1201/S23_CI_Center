# .github/workflows/0-add-new-project.yml
name: 0. Add New Kernel Project
on:
  workflow_dispatch:
    inputs:
      project_key:
        description: 'é¡¹ç›®å”¯ä¸€æ ‡è¯† (ä¾‹å¦‚ s26_sm8850)'
        required: true
      repo:
        description: 'å†…æ ¸ä»“åº“è·¯å¾„ (ä¾‹å¦‚ YuzakiKokuban/android_kernel_samsung_sm8850)'
        required: true
      defconfig:
        description: 'é¡¹ç›®çš„ Defconfig æ–‡ä»¶å'
        required: true
      localversion_base:
        description: 'å†…æ ¸ç‰ˆæœ¬å·åŸºç¡€å­—ç¬¦ä¸²'
        required: true
      lto:
        description: 'LTO é…ç½® (thin, full æˆ–ç•™ç©º)'
        required: false
        default: ''
      anykernel_repo:
        description: 'AnyKernel3 ä»“åº“ URL'
        required: true
        default: 'https://github.com/YuzakiKokuban/AnyKernel3.git'
      anykernel_branch:
        description: 'æ­¤é¡¹ç›®çš„ AnyKernel3 åˆ†æ”¯å'
        required: true
      zip_name_prefix:
        description: 'åˆ·æœºåŒ…æ–‡ä»¶åå‰ç¼€'
        required: true
      toolchain_urls:
        description: 'å·¥å…·é“¾ä¸‹è½½åœ°å€ (æ¯ä¸ª URL å ä¸€è¡Œ)'
        required: true
        type: string
      toolchain_path_prefix:
        description: 'å·¥å…·é“¾è§£å‹åçš„ prebuilts ç›¸å¯¹è·¯å¾„'
        required: true
        default: 'prebuilts'
      toolchain_path_exports:
        description: 'éœ€è¦æ·»åŠ åˆ° PATH çš„å·¥å…·é“¾å­ç›®å½• (æ¯ä¸ªè·¯å¾„å ä¸€è¡Œ)'
        required: true
        type: string
      version_method:
        description: '(å¯é€‰) ç‰ˆæœ¬å·è®¾ç½®æ–¹å¼ (file æˆ–ç•™ç©ºä½¿ç”¨é»˜è®¤çš„ param)'
        required: false
        default: 'param'
      extra_host_env:
        description: '(å¯é€‰) æ˜¯å¦éœ€è¦é¢å¤–çš„ HOST ç¯å¢ƒå˜é‡'
        required: false
        type: boolean
        default: false
      disable_security:
        description: '(å¯é€‰) éœ€è¦ç¦ç”¨çš„ä¸‰æ˜Ÿå®‰å…¨ç‰¹æ€§ (æ¯ä¸ªç‰¹æ€§å ä¸€è¡Œ)'
        required: false
        type: string

jobs:
  add-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ADMIN_TOKEN }} # ä½¿ç”¨ ADMIN_TOKEN æ¥ç¡®ä¿æœ‰æƒé™æ¨é€

      - name: Install yq and jq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
          sudo apt-get install -y jq

      - name: Update Project Files
        run: |
          # å°†å¤šè¡Œå­—ç¬¦ä¸²è¾“å…¥è½¬æ¢ä¸º JSON æ•°ç»„
          TOOLCHAIN_URLS_JSON=$(echo "${{ github.event.inputs.toolchain_urls }}" | jq -R . | jq -s .)
          TOOLCHAIN_PATH_EXPORTS_JSON=$(echo "${{ github.event.inputs.toolchain_path_exports }}" | jq -R . | jq -s .)
          
          # å¤„ç†å¯é€‰çš„ disable_security
          DISABLE_SECURITY_INPUT="${{ github.event.inputs.disable_security }}"
          if [ -n "$DISABLE_SECURITY_INPUT" ]; then
            DISABLE_SECURITY_JSON=$(echo "$DISABLE_SECURITY_INPUT" | jq -R . | jq -s .)
          else
            DISABLE_SECURITY_JSON="[]"
          fi

          # æ„å»ºæ–°çš„é¡¹ç›® JSON å¯¹è±¡
          NEW_PROJECT_JSON=$(jq -n \
            --arg repo "${{ github.event.inputs.repo }}" \
            --arg defconfig "${{ github.event.inputs.defconfig }}" \
            --arg localversion_base "${{ github.event.inputs.localversion_base }}" \
            --arg lto "${{ github.event.inputs.lto }}" \
            --argjson supported_ksu '["sukisuultra", "mksu", "ksu"]' \
            --argjson toolchain_urls "$TOOLCHAIN_URLS_JSON" \
            --arg toolchain_path_prefix "${{ github.event.inputs.toolchain_path_prefix }}" \
            --argjson toolchain_path_exports "$TOOLCHAIN_PATH_EXPORTS_JSON" \
            --arg anykernel_repo "${{ github.event.inputs.anykernel_repo }}" \
            --arg anykernel_branch "${{ github.event.inputs.anykernel_branch }}" \
            --arg zip_name_prefix "${{ github.event.inputs.zip_name_prefix }}" \
            --arg version_method "${{ github.event.inputs.version_method }}" \
            --argjson extra_host_env ${{ github.event.inputs.extra_host_env }} \
            --argjson disable_security "$DISABLE_SECURITY_JSON" \
            '{
              repo: $repo,
              defconfig: $defconfig,
              localversion_base: $localversion_base,
              lto: $lto,
              supported_ksu: $supported_ksu,
              toolchain_urls: $toolchain_urls,
              toolchain_path_prefix: $toolchain_path_prefix,
              toolchain_path_exports: $toolchain_path_exports,
              anykernel_repo: $anykernel_repo,
              anykernel_branch: $anykernel_branch,
              zip_name_prefix: $zip_name_prefix,
              version_method: $version_method,
              extra_host_env: $extra_host_env,
              disable_security: $disable_security
            }')

          # æ›´æ–° projects.json
          jq --arg key "${{ github.event.inputs.project_key }}" \
             --argjson value "$NEW_PROJECT_JSON" \
             '. + {($key): $value}' \
             configs/projects.json > tmp.json && mv tmp.json configs/projects.json
          echo "âœ… Updated configs/projects.json"

          # æ›´æ–° 2-update-kernelsu.yml
          yq e '.on.workflow_dispatch.inputs.project.options += ["${{ github.event.inputs.project_key }}"]' -i .github/workflows/2-update-kernelsu.yml
          echo "âœ… Updated .github/workflows/2-update-kernelsu.yml"

          # æ›´æ–° 4-universal-build.yml
          yq e '.on.workflow_dispatch.inputs.project.options += ["${{ github.event.inputs.project_key }}"]' -i .github/workflows/4-universal-build.yml
          echo "âœ… Updated .github/workflows/4-universal-build.yml"

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add configs/projects.json .github/workflows/2-update-kernelsu.yml .github/workflows/4-universal-build.yml
          if [[ -n $(git status --porcelain) ]]; then
            git commit -m "feat: Add new project '${{ github.event.inputs.project_key }}' via automated workflow"
            git push
            echo "ğŸš€ Changes have been committed and pushed."
          else
            echo "No changes to commit."
          fi
          
      - name: Display Next Steps
        run: |
          echo "========================================================================"
          echo "ğŸ‰ æ–°é¡¹ç›® '${{ github.event.inputs.project_key }}' å·²æˆåŠŸæ·»åŠ åˆ° CI ä¸­å¿ƒï¼"
          echo ""
          echo "ä¸‹ä¸€æ­¥æ“ä½œ:"
          echo "1. è®¿é—®æ–°çš„å†…æ ¸ä»“åº“: https://github.com/${{ github.event.inputs.repo }}"
          echo "   åœ¨ Settings -> Secrets and variables -> Actions ä¸­æ·»åŠ åä¸º 'CI_TOKEN' çš„ Secretï¼Œ"
          echo "   å…¶å€¼ä¸ºä½ çš„ Personal Access Tokenã€‚"
          echo ""
          echo "2. è¿”å›æœ¬ä»“åº“ (Kokuban_Kernel_CI_Center) çš„ Actions é¡µé¢ï¼Œ"
          echo "   è¿è¡Œ '1. Setup Kernel Repositories' å·¥ä½œæµï¼Œä¸ºæ–°ä»“åº“ä¸€é”®é…ç½®å¥½è§¦å‘å™¨ã€‚"
          echo "========================================================================"
